# 開発コンテキスト共有プロンプト

## プロジェクト概要

このプロジェクトは、**結婚式会場向けのゲスト管理・写真共有システム**です。

### 技術スタック
- **フレームワーク**: Next.js 15.1.0 (App Router)
- **言語**: TypeScript 5.5.0
- **スタイリング**: Tailwind CSS 3.4.4
- **アニメーション**: Framer Motion 12.25.0
- **状態管理**: Zustand 5.0.9
- **フォーム管理**: React Hook Form 7.70.0 + Zod 4.3.5
- **UIコンポーネント**: Radix UI
- **その他**: SWR 2.3.8 (データフェッチング), Sonner 2.0.7 (トースト通知)

### アーキテクチャ
- **管理画面（Admin）** と **ゲスト画面（Guest）** が統合されたリポジトリ
- マルチテナント対応（会場ごとに独立したダッシュボード）
- 現在はフロントエンドのみ実装済み（バックエンドAPIは未実装）
- データはモック（ダミーデータ）または `useState` で管理

### デプロイ状況
- Vercelにデプロイ済み

---

## ディレクトリ構造

```
app/
├── page.tsx                    # トップページ（ログイン画面）
├── layout.tsx                  # ルートレイアウト
├── globals.css                 # グローバルスタイル
│
├── dashboard/                  # 管理画面（会場管理者用）
│   ├── layout.tsx              # ダッシュボード共通レイアウト
│   ├── page.tsx                # ダッシュボードトップ
│   │
│   ├── [venueId]/             # 会場別ダッシュボード（動的ルート）
│   │   ├── layout.tsx
│   │   ├── page.tsx            # 会場ダッシュボードトップ
│   │   ├── weddings/           # 挙式管理
│   │   │   ├── page.tsx        # 挙式一覧
│   │   │   └── [id]/
│   │   │       └── page.tsx    # 挙式詳細（卓設定・写真管理）
│   │   ├── venues/             # 会場設定
│   │   │   └── page.tsx        # 会場一覧・QR生成
│   │   ├── accounts/           # アカウント管理
│   │   ├── notifications/      # 通知管理
│   │   └── settings/           # 設定
│   │
│   ├── weddings/              # 挙式管理（グローバル）
│   ├── venues/                # 会場管理（グローバル）
│   ├── accounts/               # アカウント管理
│   ├── notifications/          # 通知管理
│   └── settings/              # 設定
│
├── guest/                      # ゲスト画面
│   ├── page.tsx                # ゲストポータル（挙式選択・パスコード入力）
│   ├── gallery/                # 写真ギャラリー
│   │   └── page.tsx            # 写真閲覧・保存（星評価・LINE誘導ロジック含む）
│   └── survey/                 # アンケート
│       └── page.tsx            # 星評価・Google口コミ誘導
│
├── gallery/                    # ギャラリー（リダイレクト用）
│   └── page.tsx                # /guest/gallery へリダイレクト
│
├── admin/                      # 管理者画面（スーパーアドミン用）
│   ├── layout.tsx
│   └── page.tsx
│
└── venue/                      # 会場ログイン
    └── login/
        └── page.tsx            # 会場ログインページ

components/                      # 再利用可能なコンポーネント
├── admin/                      # 管理画面用コンポーネント
├── dashboard/                  # ダッシュボード用コンポーネント
├── guest/                      # ゲスト画面用コンポーネント
│   ├── Lightbox.tsx            # ライトボックス（写真拡大表示）
│   └── OpeningModal.tsx        # オープニングモーダル
├── common/                     # 共通コンポーネント
└── ui/                         # UIプリミティブ（shadcn/uiベース）

lib/                            # ユーティリティ・型定義
├── constants/                  # 定数
│   ├── external.ts             # 外部サービスURL（Google Maps, LINE）
│   └── venues.ts               # 会場情報定数
├── types/                      # TypeScript型定義
│   └── admin.ts                # 管理画面用型定義
├── store/                      # Zustandストア
├── utils/                      # ユーティリティ関数
└── swr/                        # SWR設定

schema.prisma                    # Prismaスキーマ（未使用）
```

---

## 実装済みの主要機能

### 1. 管理画面 (`/dashboard`)

#### 挙式管理 (`/dashboard/[venueId]/weddings`)
- **挙式一覧**: 挙式の一覧表示
- **挙式詳細** (`/weddings/[id]`):
  - **基本情報タブ**:
    - 新郎・新婦名の入力（姓・名を分けて入力）
    - 挙式日時の設定
    - 会場選択（Segmented Control形式）
    - メモ入力
  - **卓設定タブ**:
    - 卓の一括作成（アルファベット順・数字順・松竹梅パターン対応）
    - 卓の個別追加・編集・削除
    - 卓名のカスタマイズ
    - 最大人数の設定
  - **写真タブ**:
    - ドラッグ＆ドロップによる写真アップロード
    - 写真の一覧表示（グリッド形式）
    - 写真の削除

#### 会場設定 (`/dashboard/[venueId]/venues`)
- 会場の一覧表示（カード形式）
- 会場の新規登録・編集・削除
- **QRコード生成機能**:
  - 会場ごとのQRコード生成（`https://api.qrserver.com/v1/create-qr-code/` を使用）
  - QRコード画像のダウンロード（PNG形式）
  - QRコードURLのクリップボードコピー

#### その他の管理画面機能
- アカウント管理 (`/accounts`)
- 通知管理 (`/notifications`)
- 設定 (`/settings`)

### 2. ゲスト画面

#### ゲストポータル (`/guest`)
- **挙式選択画面**: 本日の挙式一覧を表示
- **パスコード入力画面**: 4桁のパスコード入力（テンキーパッド形式）
  - 認証成功時: 鍵が開くアニメーション → アンケート画面へ遷移
  - 認証失敗時: シェイクアニメーション
- **ダッシュボード**: ギャラリー・アンケートへのリンク

#### 写真ギャラリー (`/guest/gallery`)
- **オープニングモーダル**: 10秒のカウントダウン（広告バナー表示）
- **写真グリッド表示**: 3カラムグリッド（150枚のダミー写真）
- **インフィード広告**: 12枚おきに広告を挿入
- **ライトボックス機能**:
  - 写真の拡大表示
  - スワイプで前後の写真へ移動
  - 下方向スワイプで閉じる
- **選択モード**: 複数写真を選択して一括保存
- **保存機能**: 
  - 保存完了モーダル表示
  - **LINE誘導ロジック**: 保存完了時にLINE公式アカウントへの誘導
  - テーブルIDに基づいたメッセージ生成
- **画像右クリック/長押し**: LINE誘導モーダル表示
- **スクロールヘッダー**: スクロール時に会場名を表示

#### アンケート (`/guest/survey`)
- **星評価**: 1〜5の星評価
- **評価に応じた分岐**:
  - **高評価（4-5）**: Googleマップへの口コミ投稿誘導
  - **低評価（1-3）**: フィードバック入力フォーム
- **リダイレクト**: 評価完了後、ギャラリーへ自動遷移

### 3. 共通設定

#### `next.config.js`
```javascript
images: {
  remotePatterns: [
    {
      protocol: 'https',
      hostname: 'picsum.photos',
    },
  ],
}
```

#### 外部サービス連携
- **Google Maps**: 口コミ投稿への誘導（`lib/constants/external.ts`）
- **LINE公式アカウント**: 写真の高画質版配信への誘導（`lib/constants/external.ts`）

---

## 主要ファイルのコード抜粋

### 1. トップページ (`app/page.tsx`)

```tsx
'use client';

import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { User, Lock, ArrowRight, LogIn, LayoutDashboard } from 'lucide-react';
import { toast } from 'sonner';

// 簡易認証情報
const ADMIN_CREDENTIALS = {
  id: 'test',
  password: 'test',
};

export default function LoginPage() {
  const router = useRouter();
  const [loginId, setLoginId] = useState('');
  const [password, setPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    // 簡易認証ロジック
    if (loginId === ADMIN_CREDENTIALS.id && password === ADMIN_CREDENTIALS.password) {
      toast.success('ログイン成功', {
        description: '管理画面へ遷移します',
        duration: 2000,
      });

      setTimeout(() => {
        router.push('/admin');
      }, 500);
    } else {
      setError('IDまたはパスワードが違います');
      toast.error('ログイン失敗', {
        description: 'IDまたはパスワードが違います',
        duration: 3000,
      });
      setIsLoading(false);
    }
  };

  // ... UI実装（グラスモーフィズムデザイン、背景アニメーション）
}
```

**特徴**:
- グラスモーフィズムデザイン
- 背景に光のボケエフェクト（Framer Motion）
- 簡易認証（ID: `test`, Password: `test`）
- 会場ダッシュボードへのリンク

---

### 2. 挙式詳細・卓設定 (`app/dashboard/[venueId]/weddings/[id]/page.tsx`)

**主要機能**:

#### タブ切り替え
- `settings`: 基本情報（新郎新婦名、挙式日時、会場選択）
- `tables`: 卓設定（一括作成、個別編集）
- `photos`: 写真管理（ドラッグ＆ドロップアップロード）

#### 卓の一括作成ロジック
```tsx
// 命名パターンに基づいてテーブル名を生成
const generateTableName = (index: number, pattern: 'alphabet' | 'number' | 'matsu'): string => {
  if (pattern === 'alphabet') {
    // アルファベット順（A-Z, その後AA-ZZ...）
    const alphabetCount = 26;
    const firstLetter = String.fromCharCode(65 + (index % alphabetCount)); // A-Z
    if (index < alphabetCount) {
      return `${firstLetter}卓`;
    } else {
      const secondIndex = Math.floor(index / alphabetCount) - 1;
      const secondLetter = String.fromCharCode(65 + (secondIndex % alphabetCount));
      return `${firstLetter}${secondLetter}卓`;
    }
  } else if (pattern === 'number') {
    // 数字順
    return `${index + 1}卓`;
  } else {
    // 松竹梅パターン
    const patterns = ['松', '竹', '梅', '蘭', '菊', '桜', '楓', '桐', '桂', '杉', '柳', '柏', '椿', '菖蒲', '牡丹', '薔薇', '百合', '蓮', '向日葵', '桔梗', '撫子', '朝顔', '紫陽花', '彼岸花', '水仙', 'チューリップ'];
    const patternIndex = index % patterns.length;
    const repeatCount = Math.floor(index / patterns.length);
    if (repeatCount === 0) {
      return `${patterns[patternIndex]}卓`;
    } else {
      return `${patterns[patternIndex]}${repeatCount + 1}卓`;
    }
  }
};
```

#### 新郎新婦名のフォーマット
```tsx
// 新郎新婦の名前からフルネームを生成
const formatFullName = (
  groomSei: string,
  groomMei: string,
  brideSei: string,
  brideMei: string
): React.ReactNode => {
  const groomFull = `${groomSei.trim()} ${groomMei.trim()}`.trim();
  const brideFull = `${brideSei.trim()} ${brideMei.trim()}`.trim();
  
  if (groomFull && brideFull) {
    return (
      <span>
        <span className="text-gray-900">{groomFull}</span>
        <span className="text-gray-400 font-light mx-2">&</span>
        <span className="text-gray-900">{brideFull}</span>
        <span className="text-gray-500 ml-1">様</span>
      </span>
    );
  }
  // ...
};
```

**データ管理**:
- 挙式データ: モックデータ（`getWeddingById`関数）
- 卓データ: `useState<TableLayout[]>` で管理
- 写真データ: `useState<Photo[]>` で管理（Blob URLを使用）

---

### 3. 評価ロジック付きギャラリー (`app/guest/gallery/page.tsx`)

**主要機能**:

#### オープニングモーダル（10秒カウントダウン）
```tsx
const [showOpeningModal, setShowOpeningModal] = useState(true);
const [timeLeft, setTimeLeft] = useState(10);

useEffect(() => {
  if (!showOpeningModal) return;
  
  document.body.style.overflow = 'hidden';
  
  const timer = setInterval(() => {
    setTimeLeft((prev) => {
      if (prev <= 1) {
        setShowOpeningModal(false);
        document.body.style.overflow = 'unset';
        return 0;
      }
      return prev - 1;
    });
  }, 1000);
  
  return () => {
    clearInterval(timer);
    document.body.style.overflow = 'unset';
  };
}, [showOpeningModal]);
```

#### LINE誘導ロジック
```tsx
// LINE URL生成関数
const getLineUrl = () => {
  if (tableID) {
    const message = encodeURIComponent(`テーブル${tableID}の写真`);
    return `https://line.me/R/oaMessage/${LINE_ID}/?${message}`;
  }
  return `https://line.me/R/ti/p/${LINE_ID}`;
};
```

#### 保存完了モーダル（LINE誘導）
- 保存完了時に自動表示
- テーブルIDに基づいたメッセージ生成
- LINE公式アカウントへの誘導ボタン

#### インフィード広告
```tsx
// 12枚おきに広告を挿入
const itemsWithAds: Array<{ type: 'photo'; data: typeof photos[0] } | { type: 'ad'; index: number }> = [];
photos.forEach((photo, index) => {
  itemsWithAds.push({ type: 'photo', data: photo });
  if ((index + 1) % 12 === 0 && index < photos.length - 1) {
    itemsWithAds.push({ type: 'ad', index: Math.floor((index + 1) / 12) });
  }
});
```

#### ライトボックス（スワイプ対応）
- ドラッグで前後の写真へ移動
- 下方向スワイプで閉じる
- 画像インデックス表示

**データ**:
- 写真: 150枚のダミーデータ（`https://picsum.photos/400/300?random=${i + 1}`）
- テーブルID: URLクエリパラメータ `?table=xxx` から取得

---

### 4. QR生成 (`app/dashboard/[venueId]/venues/page.tsx`)

**QRコード生成ロジック**:
```tsx
// QRコードのURLを生成
const getQrCodeUrl = (venueId: string) => {
  const baseUrl = typeof window !== 'undefined' ? window.location.origin : 'https://example.com';
  return `${baseUrl}/venues/${venueId}`;
};

// QRコード画像のURLを生成（高解像度）
const getQrCodeImageUrl = (venueId: string) => {
  const url = getQrCodeUrl(venueId);
  // 高解像度のQRコードを生成（500x500px）
  return `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(url)}`;
};

// 画像をダウンロード
const handleDownloadQr = async () => {
  if (!selectedVenueForQr) return;
  
  try {
    const imageUrl = getQrCodeImageUrl(selectedVenueForQr.id);
    const response = await fetch(imageUrl);
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${selectedVenueForQr.name}_QRコード.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    alert('ダウンロードに失敗しました。');
  }
};
```

**機能**:
- QRコードモーダル表示
- PNG形式でのダウンロード
- URLのクリップボードコピー

---

### 5. アンケート（星評価・Google口コミ誘導） (`app/guest/survey/page.tsx`)

**評価分岐ロジック**:
```tsx
// 評価が高い場合（4-5）はGoogleマップ誘導あり、低い場合（1-3）は内部サンクスのみ
const isHighRating = rating >= 4;

// 星をクリックした瞬間にアクションステップへ遷移
const handleStarClick = (value: number) => {
  setRating(value);
  setTimeout(() => {
    setStep('action');
  }, 100);
};

// Googleマップへの誘導（星4以上の場合）
const handleMapClick = () => {
  window.open(GOOGLE_MAPS_URL, '_blank');
  setTimeout(() => {
    navigateToGallery();
  }, 300);
};
```

**フロー**:
1. **評価ステップ**: 星評価（1-5）
2. **アクションステップ**:
   - 高評価（4-5）: Googleマップへの口コミ投稿誘導
   - 低評価（1-3）: フィードバック入力フォーム
3. **リダイレクトステップ**: ギャラリーへ自動遷移

---

## 現在のステータス

### 実装済み
- ✅ フロントエンドのUI実装（ほぼ完了）
- ✅ 管理画面の主要機能（挙式管理、会場設定、QR生成）
- ✅ ゲスト画面の主要機能（ポータル、ギャラリー、アンケート）
- ✅ レスポンシブデザイン（モバイル・タブレット・デスクトップ対応）
- ✅ アニメーション（Framer Motion）
- ✅ 外部サービス連携（Google Maps, LINE）

### 未実装・要対応
- ❌ バックエンドAPI（データは現在モックまたは `useState` で管理）
- ❌ データベース連携（Prismaスキーマは存在するが未使用）
- ❌ 認証・認可システム（現在は簡易認証）
- ❌ 実際の画像アップロード（現在はBlob URLのみ）
- ❌ 本番環境用の環境変数設定

### データ管理の現状
- **挙式データ**: モックデータ（`getWeddingById`関数内で定義）
- **卓データ**: `useState<TableLayout[]>` で管理（ページリロードでリセット）
- **写真データ**: `useState<Photo[]>` で管理（Blob URLを使用、ページリロードで消失）
- **会場データ**: `useState<Venue[]>` で管理（初期値は `INITIAL_VENUES`）

### デプロイ環境
- **ホスティング**: Vercel
- **ビルドコマンド**: `next build`
- **ポート**: 開発環境は3003番ポートを使用

---

## 重要な定数・設定

### 外部サービスURL (`lib/constants/external.ts`)
```typescript
export const GOOGLE_MAPS_URL = process.env.NEXT_PUBLIC_GOOGLE_MAPS_URL || 'https://www.google.com/maps';
export const LINE_ID = process.env.NEXT_PUBLIC_LINE_ID || '@あなたのLINE_ID';
```

### 会場情報 (`lib/constants/venues.ts`)
```typescript
export const VENUE_INFO: Record<string, VenueInfo> = {
  'venue-001': { id: 'venue-001', name: '会場A' },
  'venue-002': { id: 'venue-002', name: '会場B' },
  'venue-003': { id: 'venue-003', name: '会場C' },
};
```

### 画像ドメイン設定 (`next.config.js`)
- `picsum.photos` を許可（ダミー画像用）

---

## 次のステップ（推奨）

1. **バックエンドAPIの実装**
   - Next.js API Routes または外部APIサーバー
   - データベース連携（Prisma使用）

2. **認証システムの実装**
   - NextAuth.js または Clerk の導入
   - 会場ごとの認証・認可

3. **画像アップロード機能**
   - Cloudinary または AWS S3 へのアップロード
   - 画像の最適化・リサイズ

4. **環境変数の設定**
   - `.env.local` に本番環境用の設定を追加
   - Google Maps URL, LINE ID の設定

5. **エラーハンドリングの強化**
   - エラーバウンダリーの実装
   - ローディング状態の統一

---

## 補足情報

- **フォント**: `font-shippori`（和風フォント）、`font-serif`（セリフ体）
- **カラーパレット**: 主に `stone`（ベージュ系）、`emerald`（緑系）、`champagne`（シャンパンゴールド）、`coral`（コーラルピンク）
- **アニメーション**: Framer Motionを多用（ページ遷移、モーダル、ホバーエフェクト）
- **UIパターン**: グラスモーフィズム、カードベースのレイアウト

---

以上が、現在の開発状況の完全な引き継ぎ情報です。このプロンプトをGeminiに共有することで、プロジェクトの現状を100%理解できます。
